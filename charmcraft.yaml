# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

type: charm

name: jenkins-k8s

assumes:
  - k8s-api

summary: Jenkins Continuous Integration Server

description: |
  A [Juju](https://juju.is/) [charm](https://juju.is/docs/olm/charmed-operators)
  deploying and managing [Jenkins](https://jenkins.io/) on Kubernetes. Jenkins is an open source
  automation server, providing plugins to support building, deploying and automating any project.

  Jenkins is an extendable open source continuous integration server that
  monitors executions of repeated jobs. The focus of Jenkins is the
  building/testing of software project continuously, and monitoring executions
  of externally-run jobs. More information at http://jenkins-ci.org/.

  This charm provides the Jenkins server service, and when paired with the
  jenkins agent provides an easy way to deploy Jenkins.

  For DevOps and SRE teams, this charm will make operating Jenkins simple and straightforward
  through Juju's clean interface. Allowing both kubernetes and machine agent relations, it supports
  multiple environments for automation.

links:
  documentation: https://discourse.charmhub.io/t/jenkins-k8s-documentation-overview/11169
  issues:
    - https://github.com/canonical/jenkins-k8s-operator/issues
  source:
    - https://github.com/canonical/jenkins-k8s-operator

parts:
  charm:
    source: .
    plugin: uv
    build-snaps:
      - astral-uv
  templates:
    plugin: dump
    source: .
    prime:
      - templates/jenkins-auth-proxy-config.xml
      - templates/jenkins-config.xml
      - templates/logging.properties

platforms:
  ubuntu@24.04:amd64:
  ubuntu@22.04:amd64:

containers:
  jenkins:
    resource: jenkins-image
    mounts:
      - storage: jenkins-home
        location: /var/lib/jenkins

resources:
  jenkins-image:
    type: oci-image
    description: OCI image for Jenkins

storage:
  jenkins-home:
    type: filesystem
    location: /var/lib/jenkins

requires:
  agent:
    interface: jenkins_agent_v0
    optional: true
  auth-proxy:
    interface: auth_proxy
    optional: true
    limit: 1
  ingress:
    interface: ingress
    optional: true
    limit: 1
  agent-discovery-ingress:
    interface: ingress
    optional: true
    limit: 1
  logging:
    interface: loki_push_api
provides:
  metrics-endpoint:
    interface: prometheus_scrape
  grafana-dashboard:
    interface: grafana_dashboard

config:
  options:
    restart-time-range:
      type: string
      description: >
        Preferred UTC time range in 24 hour format for restarting Jenkins. If empty, restart will
        take place whenever Jenkins needs to restart. Jenkins will need to restart on the following
        occasion. Plugins that are not part of `allowed-plugins` configuration option are detected.
        For example, 03-05 will allow Jenkins restart to take place from 3AM UTC to 5AM UTC.
        Awaits for running job completion for 5 minutes.
      default: ""
    allowed-plugins:
      type: string
      description: >
        Comma-separated list of allowed plugin short names. If empty, any plugin can be installed.
        Plugins installed by the user and their dependencies will be removed automatically if not on
        the list. Included plugins are not automatically installed.
      default: "bazaar,blueocean,dependency-check-jenkins-plugin,docker-build-publish,git,kubernetes,ldap,matrix-combinations-parameter,oic-auth,openid,pipeline-groovy-lib,postbuildscript,rebuild,reverse-proxy-auth-plugin,ssh-agent,thinBackup,pipeline-model-definition"
    system-properties:
      type: string
      default: ""
      description: |
        Comma-separated JVM system properties to pass to the Jenkins process at startup.
        Specify entries as key=value without the -D prefix. These are appended as -Dkey=value.
        Example: jenkins.model.Jenkins.crumbIssuerProxyCompatibility=true

actions:
  get-admin-password:
    description: |
      Retrieve the admin password which has been auto-generated during Jenkins install.
  rotate-credentials:
    description: |
      Invalidate all current sessions and generate a new password for admin account.

charm-libs:
  - lib: traefik-k8s.ingress
    version: "2"
  - lib: observability-libs.juju_topology
    version: "0"
  - lib: grafana-k8s.grafana_dashboard
    version: "0"
  - lib: loki-k8s.loki_push_api
    version: "0"
  - lib: prometheus-k8s.prometheus_scrape
    version: "0"
  - lib: oauth2-proxy-k8s.auth_proxy
    version: "0"
